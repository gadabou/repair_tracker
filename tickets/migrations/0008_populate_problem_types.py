# Generated by Django 5.0.14 on 2026-01-06 09:10

from django.db import migrations


def populate_problem_types(apps, schema_editor):
    """Créer les types de problèmes initiaux"""
    ProblemType = apps.get_model('tickets', 'ProblemType')

    # Définir les types de problèmes avec leurs catégories et ordres d'affichage
    problem_types = [
        # Problèmes matériels
        {'code': 'SCREEN_BROKEN', 'name': 'Écran cassé', 'category': 'HARDWARE', 'display_order': 1},
        {'code': 'SCREEN_NOT_WORKING', 'name': 'Écran ne fonctionne pas', 'category': 'HARDWARE', 'display_order': 2},
        {'code': 'BATTERY_ISSUE', 'name': 'Problème de batterie', 'category': 'HARDWARE', 'display_order': 3},
        {'code': 'CHARGING_ISSUE', 'name': 'Problème de charge', 'category': 'HARDWARE', 'display_order': 4},
        {'code': 'BUTTON_ISSUE', 'name': 'Bouton(s) défectueux', 'category': 'HARDWARE', 'display_order': 5},
        {'code': 'CAMERA_ISSUE', 'name': 'Problème de caméra', 'category': 'HARDWARE', 'display_order': 6},
        {'code': 'MICROPHONE_ISSUE', 'name': 'Problème de microphone', 'category': 'HARDWARE', 'display_order': 7},
        {'code': 'SPEAKER_ISSUE', 'name': 'Problème de haut-parleur', 'category': 'HARDWARE', 'display_order': 8},
        {'code': 'NETWORK_ISSUE', 'name': 'Problème de réseau', 'category': 'HARDWARE', 'display_order': 9},
        {'code': 'WIFI_ISSUE', 'name': 'Problème WiFi', 'category': 'HARDWARE', 'display_order': 10},
        {'code': 'BLUETOOTH_ISSUE', 'name': 'Problème Bluetooth', 'category': 'HARDWARE', 'display_order': 11},
        {'code': 'WATER_DAMAGE', 'name': 'Dégât des eaux', 'category': 'HARDWARE', 'display_order': 12},
        {'code': 'PHYSICAL_DAMAGE', 'name': 'Dommage physique', 'category': 'HARDWARE', 'display_order': 13},

        # Problèmes logiciels
        {'code': 'SOFTWARE_CRASH', 'name': 'Application plante', 'category': 'SOFTWARE', 'display_order': 1},
        {'code': 'SLOW_PERFORMANCE', 'name': 'Performance lente', 'category': 'SOFTWARE', 'display_order': 2},
        {'code': 'SYSTEM_UPDATE', 'name': 'Mise à jour système nécessaire', 'category': 'SOFTWARE', 'display_order': 3},
        {'code': 'APP_NOT_WORKING', 'name': 'Application ne fonctionne pas', 'category': 'SOFTWARE', 'display_order': 4},
        {'code': 'DATA_LOSS', 'name': 'Perte de données', 'category': 'SOFTWARE', 'display_order': 5},
        {'code': 'VIRUS_MALWARE', 'name': 'Virus/Malware', 'category': 'SOFTWARE', 'display_order': 6},

        # Autres
        {'code': 'OTHER', 'name': 'Autre problème', 'category': 'OTHER', 'display_order': 1},
    ]

    # Créer les types de problèmes
    for pt_data in problem_types:
        ProblemType.objects.get_or_create(
            code=pt_data['code'],
            defaults={
                'name': pt_data['name'],
                'category': pt_data['category'],
                'display_order': pt_data['display_order'],
                'is_active': True
            }
        )


def migrate_issue_data(apps, schema_editor):
    """Migrer les données de issue_type vers problem_type"""
    Issue = apps.get_model('tickets', 'Issue')
    ProblemType = apps.get_model('tickets', 'ProblemType')

    # Pour chaque Issue existant
    for issue in Issue.objects.all():
        if issue.issue_type and not issue.problem_type:
            try:
                # Trouver le ProblemType correspondant
                problem_type = ProblemType.objects.get(code=issue.issue_type)
                issue.problem_type = problem_type
                issue.save(update_fields=['problem_type'])
            except ProblemType.DoesNotExist:
                # Si le type n'existe pas, utiliser "Autre"
                other_type = ProblemType.objects.get(code='OTHER')
                issue.problem_type = other_type
                issue.save(update_fields=['problem_type'])


def reverse_migration(apps, schema_editor):
    """Fonction inverse pour annuler la migration"""
    ProblemType = apps.get_model('tickets', 'ProblemType')
    # Supprimer tous les ProblemType créés
    ProblemType.objects.all().delete()


class Migration(migrations.Migration):

    dependencies = [
        ('tickets', '0007_problemtype_alter_issue_issue_type_and_more'),
    ]

    operations = [
        migrations.RunPython(populate_problem_types, reverse_migration),
        migrations.RunPython(migrate_issue_data, migrations.RunPython.noop),
    ]
