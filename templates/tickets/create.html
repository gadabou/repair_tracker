{% extends 'base.html' %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<h1>Créer un Ticket</h1>
<form method="post" id="ticketForm">
    {% csrf_token %}
    <div class="mb-3">
        <label for="asc_select">ASC <span class="text-danger">*</span></label>
        <select id="asc_select" name="asc" class="form-control" required>
            <option value="">-- Sélectionner un ASC --</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="equipment_select">Équipement <span class="text-danger">*</span></label>
        <select id="equipment_select" name="equipment" class="form-control" required disabled>
            <option value="">-- Sélectionner d'abord un ASC --</option>
        </select>
        <small class="text-muted">Veuillez d'abord sélectionner un ASC</small>
    </div>

    <div class="mb-3">
        <label class="form-label fw-bold">Type(s) de problème <span class="text-danger">*</span></label>
        <small class="text-muted d-block mb-2">Sélectionnez un ou plusieurs problèmes constatés</small>

        <div class="card">
            <div class="card-header bg-light">
                <strong>Problèmes Matériels</strong>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="issue_types" value="SCREEN_BROKEN" id="issue_screen_broken">
                            <label class="form-check-label" for="issue_screen_broken">Écran cassé</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="issue_types" value="SCREEN_NOT_WORKING" id="issue_screen_not_working">
                            <label class="form-check-label" for="issue_screen_not_working">Écran ne fonctionne pas</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="issue_types" value="BATTERY_ISSUE" id="issue_battery">
                            <label class="form-check-label" for="issue_battery">Problème de batterie</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="issue_types" value="CHARGING_ISSUE" id="issue_charging">
                            <label class="form-check-label" for="issue_charging">Problème de charge</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="issue_types" value="BUTTON_ISSUE" id="issue_button">
                            <label class="form-check-label" for="issue_button">Bouton(s) défectueux</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="issue_types" value="CAMERA_ISSUE" id="issue_camera">
                            <label class="form-check-label" for="issue_camera">Problème de caméra</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="issue_types" value="MICROPHONE_ISSUE" id="issue_microphone">
                            <label class="form-check-label" for="issue_microphone">Problème de microphone</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="issue_types" value="SPEAKER_ISSUE" id="issue_speaker">
                            <label class="form-check-label" for="issue_speaker">Problème de haut-parleur</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="issue_types" value="NETWORK_ISSUE" id="issue_network">
                            <label class="form-check-label" for="issue_network">Problème de réseau</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="issue_types" value="WIFI_ISSUE" id="issue_wifi">
                            <label class="form-check-label" for="issue_wifi">Problème WiFi</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="issue_types" value="BLUETOOTH_ISSUE" id="issue_bluetooth">
                            <label class="form-check-label" for="issue_bluetooth">Problème Bluetooth</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="issue_types" value="WATER_DAMAGE" id="issue_water">
                            <label class="form-check-label" for="issue_water">Dégât des eaux</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="issue_types" value="PHYSICAL_DAMAGE" id="issue_physical">
                            <label class="form-check-label" for="issue_physical">Dommage physique</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-header bg-light">
                <strong>Problèmes Logiciels</strong>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="issue_types" value="SOFTWARE_CRASH" id="issue_crash">
                            <label class="form-check-label" for="issue_crash">Application plante</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="issue_types" value="SLOW_PERFORMANCE" id="issue_slow">
                            <label class="form-check-label" for="issue_slow">Performance lente</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="issue_types" value="SYSTEM_UPDATE" id="issue_update">
                            <label class="form-check-label" for="issue_update">Mise à jour système nécessaire</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="issue_types" value="APP_NOT_WORKING" id="issue_app">
                            <label class="form-check-label" for="issue_app">Application ne fonctionne pas</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="issue_types" value="DATA_LOSS" id="issue_data">
                            <label class="form-check-label" for="issue_data">Perte de données</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="issue_types" value="VIRUS_MALWARE" id="issue_virus">
                            <label class="form-check-label" for="issue_virus">Virus/Malware</label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mt-3">
            <div class="card-body">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="issue_types" value="OTHER" id="issue_other">
                    <label class="form-check-label fw-bold" for="issue_other">Autre problème</label>
                </div>
            </div>
        </div>

        <div id="issue-error" class="text-danger small mt-2" style="display: none;">
            Veuillez sélectionner au moins un problème
        </div>
    </div>

    <div class="mb-3">
        <label>Description du problème <span class="text-danger">*</span></label>
        <textarea name="problem_description" class="form-control" rows="4" required placeholder="Décrivez en détail le(s) problème(s) constaté(s)..."></textarea>
    </div>

    <div class="mb-3">
        <label>Description additionnelle des problèmes techniques</label>
        <textarea name="issue_description" class="form-control" rows="2" placeholder="Informations complémentaires sur les problèmes sélectionnés (optionnel)..."></textarea>
        <small class="text-muted">Cette description s'appliquera à tous les problèmes sélectionnés ci-dessus</small>
    </div>
    <button type="submit" class="btn btn-primary">Créer</button>
    <a href="{% url 'tickets:list' %}" class="btn btn-secondary">Annuler</a>
</form>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    // Validation du formulaire - au moins un problème doit être sélectionné
    $('#ticketForm').on('submit', function(e) {
        const checkedIssues = $('input[name="issue_types"]:checked').length;
        const errorDiv = $('#issue-error');

        if (checkedIssues === 0) {
            e.preventDefault();
            errorDiv.show();
            $('html, body').animate({
                scrollTop: errorDiv.offset().top - 100
            }, 500);
            return false;
        }
        errorDiv.hide();
        return true;
    });

    // Cacher le message d'erreur quand on sélectionne un problème
    $('input[name="issue_types"]').on('change', function() {
        if ($('input[name="issue_types"]:checked').length > 0) {
            $('#issue-error').hide();
        }
    });

    // Initialiser Select2 pour le champ ASC
    $('#asc_select').select2({
        theme: 'bootstrap-5',
        placeholder: '-- Sélectionner un ASC --',
        allowClear: true,
        ajax: {
            url: '/api/ascs/',
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    search: params.term,
                    page: params.page || 1
                };
            },
            processResults: function (data) {
                return {
                    results: data.results.map(function(asc) {
                        return {
                            id: asc.id,
                            text: asc.first_name + ' ' + asc.last_name + ' (' + asc.code + ')'
                        };
                    })
                };
            },
            cache: true
        }
    });

    // Initialiser Select2 pour le champ équipement
    $('#equipment_select').select2({
        theme: 'bootstrap-5',
        placeholder: '-- Sélectionner un équipement --',
        allowClear: true
    });

    // Charger les équipements quand un ASC est sélectionné
    $('#asc_select').on('change', function() {
        const ascId = $(this).val();
        const equipmentSelect = $('#equipment_select');

        if (ascId) {
            // Activer le champ équipement et charger les données
            equipmentSelect.prop('disabled', false);
            equipmentSelect.empty().append('<option value="">-- Chargement... --</option>');

            // Récupérer les équipements de l'ASC sélectionné
            $.ajax({
                url: '/api/equipment/',
                data: { asc_id: ascId },
                dataType: 'json',
                success: function(data) {
                    equipmentSelect.empty().append('<option value="">-- Sélectionner un équipement --</option>');

                    // Gérer la réponse paginée de DRF ou un tableau direct
                    const equipments = data.results || data;

                    if (equipments.length === 0) {
                        equipmentSelect.append('<option value="" disabled>Aucun équipement disponible pour cet ASC</option>');
                    } else {
                        equipments.forEach(function(equipment) {
                            equipmentSelect.append(
                                $('<option></option>')
                                    .val(equipment.id)
                                    .text(equipment.brand + ' ' + equipment.model + ' (' + equipment.imei + ')')
                            );
                        });
                    }

                    // Réinitialiser Select2
                    equipmentSelect.select2({
                        theme: 'bootstrap-5',
                        placeholder: '-- Sélectionner un équipement --',
                        allowClear: true
                    });
                },
                error: function(xhr, status, error) {
                    console.error('Erreur de chargement des équipements:', error);
                    equipmentSelect.empty().append('<option value="">-- Erreur de chargement --</option>');
                }
            });
        } else {
            // Désactiver le champ équipement si aucun ASC n'est sélectionné
            equipmentSelect.prop('disabled', true);
            equipmentSelect.empty().append('<option value="">-- Sélectionner d\'abord un ASC --</option>');
            equipmentSelect.select2({
                theme: 'bootstrap-5',
                placeholder: '-- Sélectionner d\'abord un ASC --'
            });
        }
    });
});
</script>
{% endblock %}
