{% extends 'base.html' %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<h1>Créer un Ticket</h1>
<form method="post" id="ticketForm">
    {% csrf_token %}
    <div class="mb-3">
        <label for="asc_select">ASC <span class="text-danger">*</span></label>
        <select id="asc_select" name="asc" class="form-control" required>
            <option value="">-- Sélectionner un ASC --</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="equipment_select">Équipement <span class="text-danger">*</span></label>
        <select id="equipment_select" name="equipment" class="form-control" required disabled>
            <option value="">-- Sélectionner d'abord un ASC --</option>
        </select>
        <small class="text-muted">Veuillez d'abord sélectionner un ASC</small>
    </div>

    <div class="mb-3">
        <label class="form-label fw-bold">Type(s) de problème <span class="text-danger">*</span></label>
        <small class="text-muted d-block mb-2">Sélectionnez un ou plusieurs problèmes constatés</small>

        {% if hardware_problems %}
        <div class="card">
            <div class="card-header bg-light">
                <strong>Problèmes Matériels</strong>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        {% for problem in hardware_problems %}
                            {% if forloop.counter0 == hardware_problems|length|add:1|divisibleby:2 %}
                                </div><div class="col-md-6">
                            {% endif %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="problem_types" value="{{ problem.id }}" id="problem_{{ problem.id }}">
                                <label class="form-check-label" for="problem_{{ problem.id }}">{{ problem.name }}</label>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if software_problems %}
        <div class="card mt-3">
            <div class="card-header bg-light">
                <strong>Problèmes Logiciels</strong>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        {% for problem in software_problems %}
                            {% if forloop.counter0 == software_problems|length|add:1|divisibleby:2 %}
                                </div><div class="col-md-6">
                            {% endif %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="problem_types" value="{{ problem.id }}" id="problem_{{ problem.id }}">
                                <label class="form-check-label" for="problem_{{ problem.id }}">{{ problem.name }}</label>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        {% if other_problems %}
        <div class="card mt-3">
            <div class="card-body">
                {% for problem in other_problems %}
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="problem_types" value="{{ problem.id }}" id="problem_{{ problem.id }}">
                    <label class="form-check-label fw-bold" for="problem_{{ problem.id }}">{{ problem.name }}</label>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <div id="issue-error" class="text-danger small mt-2" style="display: none;">
            Veuillez sélectionner au moins un problème
        </div>
    </div>

    <div class="mb-3">
        <label>Description du problème <span class="text-danger">*</span></label>
        <textarea name="problem_description" class="form-control" rows="4" required placeholder="Décrivez en détail le(s) problème(s) constaté(s)..."></textarea>
    </div>

    <div class="mb-3">
        <label>Description additionnelle des problèmes techniques</label>
        <textarea name="issue_description" class="form-control" rows="2" placeholder="Informations complémentaires sur les problèmes sélectionnés (optionnel)..."></textarea>
        <small class="text-muted">Cette description s'appliquera à tous les problèmes sélectionnés ci-dessus</small>
    </div>
    <button type="submit" class="btn btn-primary">Créer</button>
    <a href="{% url 'tickets:list' %}" class="btn btn-secondary">Annuler</a>
</form>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    // Validation du formulaire - au moins un problème doit être sélectionné
    $('#ticketForm').on('submit', function(e) {
        const checkedIssues = $('input[name="problem_types"]:checked').length;
        const errorDiv = $('#issue-error');

        if (checkedIssues === 0) {
            e.preventDefault();
            errorDiv.show();
            $('html, body').animate({
                scrollTop: errorDiv.offset().top - 100
            }, 500);
            return false;
        }
        errorDiv.hide();
        return true;
    });

    // Cacher le message d'erreur quand on sélectionne un problème
    $('input[name="problem_types"]').on('change', function() {
        if ($('input[name="problem_types"]:checked').length > 0) {
            $('#issue-error').hide();
        }
    });

    // Initialiser Select2 pour le champ ASC
    $('#asc_select').select2({
        theme: 'bootstrap-5',
        placeholder: '-- Sélectionner un ASC --',
        allowClear: true,
        width: '100%',
        ajax: {
            url: '/api/ascs/',
            dataType: 'json',
            delay: 250,
            data: function (params) {
                return {
                    search: params.term,
                    page: params.page || 1
                };
            },
            processResults: function (data) {
                return {
                    results: data.results.map(function(asc) {
                        return {
                            id: asc.id,
                            text: asc.first_name + ' ' + asc.last_name + ' (' + asc.code + ')'
                        };
                    })
                };
            },
            cache: true
        }
    });

    // Initialiser Select2 pour le champ équipement
    $('#equipment_select').select2({
        theme: 'bootstrap-5',
        placeholder: '-- Sélectionner un équipement --',
        allowClear: true,
        width: '100%'
    });

    // Charger les équipements quand un ASC est sélectionné
    $('#asc_select').on('change', function() {
        const ascId = $(this).val();
        const equipmentSelect = $('#equipment_select');

        if (ascId) {
            // Activer le champ équipement et charger les données
            equipmentSelect.prop('disabled', false);

            // Détruire Select2 s'il existe
            if (equipmentSelect.hasClass("select2-hidden-accessible")) {
                equipmentSelect.select2('destroy');
            }

            equipmentSelect.empty().append('<option value="">-- Chargement... --</option>');

            // Récupérer les équipements de l'ASC sélectionné
            console.log('Chargement des équipements pour ASC ID:', ascId);
            $.ajax({
                url: '/api/equipment/',
                data: { asc_id: ascId },
                dataType: 'json',
                success: function(data) {
                    console.log('Équipements reçus:', data);

                    // Vider et reconstruire les options
                    equipmentSelect.empty();
                    equipmentSelect.append('<option value="">-- Sélectionner un équipement --</option>');

                    // Gérer la réponse paginée de DRF ou un tableau direct
                    const equipments = data.results || data;
                    console.log('Nombre d\'équipements:', equipments.length);

                    if (equipments.length === 0) {
                        equipmentSelect.append('<option value="" disabled>Aucun équipement disponible pour cet ASC</option>');
                        console.warn('Aucun équipement trouvé pour cet ASC');
                    } else {
                        equipments.forEach(function(equipment) {
                            const optionText = equipment.brand + ' ' + equipment.model + ' (' + equipment.imei + ')';
                            equipmentSelect.append(new Option(optionText, equipment.id, false, false));
                        });
                        console.log('Équipements ajoutés au select');
                    }

                    // Réinitialiser Select2 après l'ajout des options
                    equipmentSelect.select2({
                        theme: 'bootstrap-5',
                        placeholder: '-- Sélectionner un équipement --',
                        allowClear: true,
                        width: '100%'
                    });

                    console.log('Select2 réinitialisé');
                },
                error: function(xhr, status, error) {
                    console.error('Erreur de chargement des équipements:', error);
                    console.error('Status:', status);
                    console.error('Response:', xhr.responseText);
                    equipmentSelect.empty().append('<option value="">-- Erreur de chargement --</option>');

                    // Réinitialiser Select2 même en cas d'erreur
                    equipmentSelect.select2({
                        theme: 'bootstrap-5',
                        placeholder: '-- Erreur de chargement --',
                        width: '100%'
                    });

                    alert('Erreur lors du chargement des équipements. Veuillez réessayer.');
                }
            });
        } else {
            // Désactiver le champ équipement si aucun ASC n'est sélectionné
            equipmentSelect.prop('disabled', true);

            // Détruire Select2 s'il existe
            if (equipmentSelect.hasClass("select2-hidden-accessible")) {
                equipmentSelect.select2('destroy');
            }

            equipmentSelect.empty().append('<option value="">-- Sélectionner d\'abord un ASC --</option>');

            equipmentSelect.select2({
                theme: 'bootstrap-5',
                placeholder: '-- Sélectionner d\'abord un ASC --',
                width: '100%'
            });
        }
    });
});
</script>
{% endblock %}
